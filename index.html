<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>40Hz Gamma Entrainment PoC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --strobe-opacity: 0;
        }
        body {
            background-color: #000;
            color: #fff;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        /* 視覚刺激用レイヤー */
        #strobeLayer {
            position: fixed;
            inset: 0;
            background-color: #fff;
            opacity: var(--strobe-opacity);
            pointer-events: none;
            z-index: 50;
        }
        .control-panel {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #333;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div id="strobeLayer"></div>

    <!-- 安全警告（初回のみ） -->
    <div id="safetyOverlay" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-4 text-center">
        <div class="max-w-md space-y-6">
            <h2 class="text-2xl font-bold text-red-500 underline decoration-2 underline-offset-8">WARNING: PHOTIC STIMULATION</h2>
            <p class="text-gray-300 text-sm leading-relaxed">
                このPoCは40Hzの高速な光点滅（ストロボ）を生成します。<br>
                光過敏性てんかんの既往がある方は使用できません。<br>
                また、使用中に不快感を感じた場合は直ちに停止してください。
            </p>
            <button onclick="dismissSafety()" class="px-8 py-3 bg-white text-black font-bold hover:bg-gray-200 transition">
                UNDERSTOOD & PROCEED
            </button>
        </div>
    </div>

    <!-- メインUI -->
    <div class="control-panel w-full max-w-sm rounded-lg p-8 space-y-10 relative z-10">
        <div class="space-y-2">
            <h1 class="text-xl font-bold tracking-tighter">40Hz GEN-1 PoC</h1>
            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Scientific Fidelity / Multisensory Mode</p>
        </div>

        <!-- 状態表示 -->
        <div class="flex items-center space-x-4 border-l-2 border-indigo-500 pl-4 py-2">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-600"></div>
            <div class="text-sm font-bold uppercase tracking-tight">
                Status: <span id="statusText" class="text-gray-500">Idle</span>
            </div>
        </div>

        <div class="space-y-8">
            <!-- 音量 -->
            <div class="space-y-4">
                <div class="flex justify-between text-[10px] uppercase font-bold text-gray-400">
                    <span>Acoustic Pulse (1000Hz Carrier)</span>
                    <span id="volVal">50%</span>
                </div>
                <input type="range" id="volRange" min="0" max="100" value="50" class="w-full accent-indigo-500">
            </div>

            <!-- ストロボ制御 -->
            <div class="flex items-center justify-between p-4 bg-white/5 rounded">
                <div class="space-y-1">
                    <div class="text-[10px] font-bold uppercase text-indigo-400">Visual Strobe (40Hz)</div>
                    <div class="text-[9px] text-gray-500 italic">2024 Nature Study Sync</div>
                </div>
                <button id="strobeToggle" onclick="toggleStrobe()" class="w-12 h-6 rounded-full bg-gray-600 relative transition-colors">
                    <div id="strobeKnob" class="absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform"></div>
                </button>
            </div>
        </div>

        <!-- 再生ボタン -->
        <button id="mainBtn" onclick="handleStart()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition flex items-center justify-center space-x-3">
            <span id="btnText">INITIATE ENTRAYMENT</span>
        </button>

        <footer class="text-[9px] text-gray-600 leading-tight">
            * 40Hz Audio Pulse (Square Wave Modulation)<br>
            * 40Hz Visual Flicker (Multisensory Integration)<br>
            Reference: Nature 2024 / Cell 2019
        </footer>
    </div>

    <script>
        let audioCtx, masterGain, carrier, modulator;
        let isRunning = false;
        let strobeEnabled = false;
        let strobeRaf;

        function dismissSafety() {
            document.getElementById('safetyOverlay').style.display = 'none';
        }

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.connect(audioCtx.destination);
                updateVolume();
            }
            if (audioCtx.state === 'suspended') await audioCtx.resume();
        }

        function handleStart() {
            if (isRunning) stop();
            else start();
        }

        async function start() {
            await initAudio();
            const now = audioCtx.currentTime;

            // --- 40Hz Acoustic Pulse (忠実再現) ---
            // 論文にある「40Hzパルス」は、聞き取りやすい基音を40Hzでオンオフさせるもの。
            carrier = audioCtx.createOscillator();
            modulator = audioCtx.createOscillator();
            const amGain = audioCtx.createGain();

            carrier.type = 'sine';
            carrier.frequency.setValueAtTime(1000, now); // 基音 1000Hz (パルスが際立つ)

            modulator.type = 'square'; // パルス状の急峻な変化を作る
            modulator.frequency.setValueAtTime(40, now); // 40Hz固定

            // モジュレーション深度調整 (0-1のスイッチング)
            const depth = audioCtx.createGain();
            depth.gain.value = 0.5;
            modulator.connect(depth).connect(amGain.gain);
            amGain.gain.value = 0.5;

            carrier.connect(amGain).connect(masterGain);

            carrier.start();
            modulator.start();

            // --- 40Hz Visual Strobe (忠実再現) ---
            if (strobeEnabled) startStrobe();

            isRunning = true;
            updateUI(true);
        }

        function stop() {
            if (carrier) carrier.stop();
            if (modulator) modulator.stop();
            cancelAnimationFrame(strobeRaf);
            document.documentElement.style.setProperty('--strobe-opacity', 0);
            isRunning = false;
            updateUI(false);
        }

        function startStrobe() {
            const interval = 1000 / 40; // 25ms周期
            let lastTime = performance.now();
            let visible = false;

            function loop(now) {
                if (!isRunning || !strobeEnabled) return;
                if (now - lastTime >= interval / 2) {
                    visible = !visible;
                    document.documentElement.style.setProperty('--strobe-opacity', visible ? '0.4' : '0');
                    lastTime = now;
                }
                strobeRaf = requestAnimationFrame(loop);
            }
            strobeRaf = requestAnimationFrame(loop);
        }

        function toggleStrobe() {
            strobeEnabled = !strobeEnabled;
            const knob = document.getElementById('strobeKnob');
            const bg = document.getElementById('strobeToggle');
            knob.style.transform = strobeEnabled ? 'translateX(24px)' : 'translateX(0)';
            bg.style.backgroundColor = strobeEnabled ? '#4f46e5' : '#4b5563';
            
            if (isRunning) {
                if (strobeEnabled) startStrobe();
                else {
                    cancelAnimationFrame(strobeRaf);
                    document.documentElement.style.setProperty('--strobe-opacity', 0);
                }
            }
        }

        function updateUI(active) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const btn = document.getElementById('mainBtn');
            const btnText = document.getElementById('btnText');

            if (active) {
                dot.className = "w-3 h-3 rounded-full bg-indigo-500 animate-pulse";
                text.innerText = "Active (40Hz)";
                text.className = "text-indigo-500";
                btn.className = "w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold transition flex items-center justify-center space-x-3";
                btnText.innerText = "TERMINATE STIMULATION";
            } else {
                dot.className = "w-3 h-3 rounded-full bg-gray-600";
                text.innerText = "Idle";
                text.className = "text-gray-500";
                btn.className = "w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition flex items-center justify-center space-x-3";
                btnText.innerText = "INITIATE ENTRAYMENT";
            }
        }

        function updateVolume() {
            const val = document.getElementById('volRange').value;
            document.getElementById('volVal').innerText = val + '%';
            if (masterGain) masterGain.gain.setTargetAtTime(val / 100, audioCtx.currentTime, 0.05);
        }

        document.getElementById('volRange').oninput = updateVolume;

    </script>
</body>
</html>
